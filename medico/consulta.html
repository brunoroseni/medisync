<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consultas - MediSync</title>
    <link rel="stylesheet" href="../assets/css/main.css" />
  </head>

  <body class="main-layout">
    <!-- Header -->
    <header class="header">
      <div class="container">
        <nav class="nav">
          <div class="logo">
            <img
              src="../assets/img/logo-medisync.PNG"
              alt="MediSync Logo"
              style="height: 40px; vertical-align: middle; margin-right: 8px"
            />
            <h2
              style="
                color: var(--azul-escuro);
                display: inline-block;
                vertical-align: middle;
                margin: 0;
              "
            >
              MediSync
            </h2>
          </div>
          <div class="nav-menu" id="menu-consultas">
            <a href="dash-medico.html" class="nav-link">Dashboard</a>
            <a
              href="consulta.html"
              class="nav-link"
              style="background: var(--cinza-neutro)"
              >Consultas</a
            >
            <a href="cad-paciente.html" class="nav-link">Cadastrar Paciente</a>
            <a href="#relatorios" class="nav-link">Relat√≥rios</a>
            <button onclick="logout()" class="btn btn-danger">Sair</button>
          </div>
          <button
            class="mobile-menu-toggle"
            type="button"
            aria-expanded="false"
            aria-controls="menu-consultas"
          >
            <span class="sr-only">Alternar menu</span>
            <span class="mobile-menu-toggle__icon" aria-hidden="true"></span>
          </button>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
          <div>
            <h1>Gerenciar Consultas</h1>
            <p>Registre novas consultas e acompanhe o hist√≥rico cl√≠nico</p>
          </div>
          <button class="btn btn-primary" onclick="showNewConsultaForm()">
            <span class="material-symbols-rounded" aria-hidden="true">add</span>
            Nova Consulta
          </button>
        </div>

        <!-- Nova Consulta Form (Wizard) -->
        <div
          id="newConsultaForm"
          class="wizard-container fade-in"
          style="display: none"
        >
          <div class="wizard-header">
            <div class="wizard-steps">
              <div class="wizard-step active" data-step="1">
                <div class="wizard-step-number">1</div>
                <div class="wizard-step-text">Dados B√°sicos</div>
              </div>
              <div class="wizard-step" data-step="2">
                <div class="wizard-step-number">2</div>
                <div class="wizard-step-text">Exame Cl√≠nico</div>
              </div>
              <div class="wizard-step" data-step="3">
                <div class="wizard-step-number">3</div>
                <div class="wizard-step-text">Diagn√≥stico</div>
              </div>
            </div>
            <h3 style="margin: 0; font-size: 24px">Nova Consulta M√©dica</h3>
            <button
              style="
                position: absolute;
                top: 16px;
                right: 16px;
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                font-size: 20px;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                transition: background 0.2s;
              "
              onclick="hideNewConsultaForm()"
              onmouseover="this.style.background='rgba(255,255,255,0.3)'"
              onmouseout="this.style.background='rgba(255,255,255,0.2)'"
            >
              √ó
            </button>
          </div>

          <form id="consultaForm">
            <!-- Etapa 1: Dados B√°sicos -->
            <div class="wizard-content" id="step-1">
              <h4
                style="
                  margin-top: 0;
                  color: var(--azul-escuro);
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <span class="material-symbols-rounded">assignment</span>
                Informa√ß√µes B√°sicas da Consulta
              </h4>

              <div class="grid grid-2">
                <div class="form-group">
                  <label class="form-label">Buscar Paciente *</label>
                  <input
                    type="text"
                    class="form-input"
                    placeholder="Digite nome ou CPF do paciente"
                    onkeyup="searchPatients(this.value)"
                    required
                  />
                  <div id="patientResults" class="mt-2"></div>
                </div>
                <div class="form-group">
                  <label class="form-label">Data e Hora da Consulta *</label>
                  <input type="datetime-local" class="form-input" required />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Tipo de Consulta *</label>
                <select class="form-select" required>
                  <option value="">Selecione o tipo</option>
                  <option value="primeira">Primeira consulta</option>
                  <option value="retorno">Consulta de retorno</option>
                  <option value="urgencia">Consulta de urg√™ncia</option>
                  <option value="rotina">Consulta de rotina</option>
                  <option value="pre-operatoria">
                    Avalia√ß√£o pr√©-operat√≥ria
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Motivo da Consulta / Queixa Principal *</label
                >
                <textarea
                  class="form-input"
                  rows="3"
                  required
                  placeholder="Ex: Dor tor√°cica h√° 2 dias, palpita√ß√µes, dispneia aos esfor√ßos..."
                ></textarea>
              </div>

              <div class="medical-alert">
                <span class="medical-alert-icon">üí°</span>
                <div class="medical-alert-content">
                  <h4>Dica Cl√≠nica</h4>
                  <p>
                    Documente a queixa principal nas palavras do paciente e
                    inclua o tempo de evolu√ß√£o dos sintomas.
                  </p>
                </div>
              </div>
            </div>

            <!-- Etapa 2: Exame Cl√≠nico -->
            <div class="wizard-content" id="step-2" style="display: none">
              <h4
                style="
                  margin-top: 0;
                  color: var(--azul-escuro);
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <span class="material-symbols-rounded">monitor_heart</span>
                Exame F√≠sico e Sinais Vitais
              </h4>

              <div
                class="card"
                style="background: #f8f9fa; margin-bottom: 24px"
              >
                <h5 style="margin: 0 0 16px 0; color: var(--azul-escuro)">
                  Sinais Vitais
                </h5>
                <div class="grid grid-4">
                  <div class="form-group">
                    <label class="form-label">Press√£o Arterial (mmHg)</label>
                    <input
                      type="text"
                      class="form-input"
                      placeholder="120x80"
                      pattern="[0-9]{2,3}x[0-9]{2,3}"
                      data-validate="pa"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">FC (bpm)</label>
                    <input
                      type="number"
                      class="form-input"
                      placeholder="72"
                      min="30"
                      max="220"
                      data-validate="fc"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Temperatura (¬∞C)</label>
                    <input
                      type="number"
                      step="0.1"
                      class="form-input"
                      placeholder="36.5"
                      min="32"
                      max="45"
                      data-validate="temp"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Sat. O‚ÇÇ (%)</label>
                    <input
                      type="number"
                      class="form-input"
                      placeholder="98"
                      min="70"
                      max="100"
                    />
                  </div>
                </div>
              </div>

              <div
                class="card"
                style="background: #f8f9fa; margin-bottom: 24px"
              >
                <h5 style="margin: 0 0 16px 0; color: var(--azul-escuro)">
                  Dados Antropom√©tricos
                </h5>
                <div class="grid grid-3">
                  <div class="form-group">
                    <label class="form-label">Peso (kg)</label>
                    <input
                      type="number"
                      step="0.1"
                      class="form-input"
                      placeholder="70.5"
                      onchange="calculateIMC()"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Altura (cm)</label>
                    <input
                      type="number"
                      class="form-input"
                      placeholder="175"
                      onchange="calculateIMC()"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">IMC (kg/m¬≤)</label>
                    <input
                      type="text"
                      class="form-input"
                      id="imcResult"
                      placeholder="Calculado automaticamente"
                      readonly
                    />
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Hist√≥ria da Doen√ßa Atual (HDA)</label>
                <textarea
                  class="form-input"
                  rows="4"
                  placeholder="Descreva a evolu√ß√£o dos sintomas, fatores de melhora/piora, sintomas associados, tratamentos j√° realizados..."
                ></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">Exame F√≠sico por Aparelhos</label>
                <textarea
                  class="form-input"
                  rows="4"
                  placeholder="ACV: bulhas normofon√©ticas, ritmo regular, sem sopros&#10;AR: murm√∫rio vesicular universal, sem ru√≠dos advent√≠cios&#10;ABD: plano, fl√°cido, indolor, ru√≠dos hidroa√©reos presentes&#10;Extremidades: sem edemas, pulsos palp√°veis"
                ></textarea>
              </div>

              <div class="medical-alert critical">
                <span class="medical-alert-icon">‚ö†Ô∏è</span>
                <div class="medical-alert-content">
                  <h4>Alerta de Seguran√ßa</h4>
                  <p>
                    Verifique sempre sinais vitais cr√≠ticos. PA > 180x110 ou <
                    90x60, FC > 120 ou < 50, Temp > 38.5¬∞C requerem aten√ß√£o
                    especial.
                  </p>
                </div>
              </div>
            </div>

            <!-- Etapa 3: Diagn√≥stico e Conduta -->
            <div class="wizard-content" id="step-3" style="display: none">
              <h4
                style="
                  margin-top: 0;
                  color: var(--azul-escuro);
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <span class="material-symbols-rounded">medical_services</span>
                Diagn√≥stico e Conduta M√©dica
              </h4>

              <div class="form-group">
                <label class="form-label"
                  >Hip√≥teses Diagn√≥sticas (CID-10)</label
                >
                <input
                  type="text"
                  class="form-input"
                  placeholder="Digite para buscar CID-10..."
                  onkeyup="searchCID10Suggestions(this.value)"
                  id="cidSearch"
                />
                <div id="cid10Results" style="margin-top: 8px"></div>
                <div id="selectedDiagnoses" style="margin-top: 12px"></div>
              </div>

              <div class="form-group">
                <label class="form-label">Prescri√ß√£o M√©dica</label>
                <textarea
                  class="form-input"
                  rows="6"
                  placeholder="1. Losartana 50mg - VO - 1x/dia - pela manh√£ - 30 dias&#10;2. Dieta hiposs√≥dica&#10;3. Atividade f√≠sica regular 30 min/dia&#10;4. Controle de peso&#10;5. Retorno em 30 dias com exames"
                ></textarea>
              </div>

              <div class="form-group">
                <label class="form-label"
                  >Exames Complementares Solicitados</label
                >
                <textarea
                  class="form-input"
                  rows="3"
                  placeholder="‚Ä¢ Hemograma completo&#10;‚Ä¢ Glicemia de jejum&#10;‚Ä¢ Ureia, creatinina&#10;‚Ä¢ ECG de repouso"
                ></textarea>
              </div>

              <div class="grid grid-2">
                <div class="form-group">
                  <label class="form-label">Data de Retorno</label>
                  <input type="date" class="form-input" />
                </div>
                <div class="form-group">
                  <label class="form-label">Urg√™ncia do Retorno</label>
                  <select class="form-select">
                    <option value="">N√£o especificado</option>
                    <option value="alta">Alta - at√© 7 dias</option>
                    <option value="media">M√©dia - at√© 30 dias</option>
                    <option value="baixa">Baixa - conforme necess√°rio</option>
                    <option value="sos">SOS (se necess√°rio)</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Orienta√ß√µes e Sinais de Alerta</label>
                <textarea
                  class="form-input"
                  rows="3"
                  placeholder="Orienta√ß√µes espec√≠ficas ao paciente, sinais de alerta para retorno imediato, cuidados especiais..."
                ></textarea>
              </div>

              <div class="medical-alert success">
                <span class="medical-alert-icon">‚úÖ</span>
                <div class="medical-alert-content">
                  <h4>Checklist Final</h4>
                  <p>
                    Verifique se diagn√≥stico, prescri√ß√£o e orienta√ß√µes est√£o
                    completas antes de finalizar.
                  </p>
                </div>
              </div>
            </div>

            <!-- Navega√ß√£o do Wizard -->
            <div class="wizard-actions">
              <div>
                <button
                  type="button"
                  id="prevBtn"
                  class="btn btn-secondary"
                  onclick="changeStep(-1)"
                  style="display: none"
                >
                  ‚Üê Voltar
                </button>
              </div>
              <div style="display: flex; gap: 12px">
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="hideNewConsultaForm()"
                >
                  Cancelar
                </button>
                <button
                  type="button"
                  id="nextBtn"
                  class="btn btn-primary"
                  onclick="changeStep(1)"
                >
                  Pr√≥ximo ‚Üí
                </button>
                <button
                  type="submit"
                  id="submitBtn"
                  class="btn btn-primary"
                  style="display: none"
                >
                  <span class="material-symbols-rounded" aria-hidden="true"
                    >check_circle</span
                  >
                  Finalizar Consulta
                </button>
              </div>
            </div>
          </form>
        </div>

        <!-- Busca e Filtros -->
        <div class="card" style="margin-top: 32px">
          <div class="card-header">
            <h3 class="card-title">Filtros de Consulta</h3>
          </div>

          <div class="grid grid-4 mb-4">
            <div class="form-group">
              <label class="form-label">Buscar Paciente</label>
              <input type="text" class="form-input" placeholder="Nome ou CPF" />
            </div>
            <div class="form-group">
              <label class="form-label">Data Inicial</label>
              <input type="date" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label">Data Final</label>
              <input type="date" class="form-input" />
            </div>
            <div class="form-group d-flex align-end">
              <button class="btn btn-secondary w-100">
                <span class="material-symbols-rounded" aria-hidden="true"
                  >search</span
                >
                Buscar
              </button>
            </div>
          </div>
        </div>

        <!-- Lista de Consultas -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Consultas Realizadas</h3>
            <button class="btn btn-outline">
              <span class="material-symbols-rounded" aria-hidden="true"
                >download</span
              >
              Exportar
            </button>
          </div>

          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Data/Hora</th>
                  <th>Paciente</th>
                  <th>Motivo</th>
                  <th>Diagn√≥stico (CID-10)</th>
                  <th>Status</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <strong>06/11/2025 14:30</strong><br />
                    <small class="text-muted">Hoje</small>
                  </td>
                  <td>
                    <strong>Jo√£o Silva</strong><br />
                    <small class="text-muted">45 anos, M</small>
                  </td>
                  <td>Consulta de retorno cardiol√≥gico</td>
                  <td>
                    <strong>I10</strong> - Hipertens√£o arterial<br />
                    <small class="text-success">Controlada</small>
                  </td>
                  <td><span class="badge badge--success">Finalizada</span></td>
                  <td>
                    <button class="btn btn-secondary btn-sm">
                      <span class="material-symbols-rounded" aria-hidden="true"
                        >visibility</span
                      >
                      Ver
                    </button>
                    <button class="btn btn-outline btn-sm">
                      <span class="material-symbols-rounded" aria-hidden="true"
                        >print</span
                      >
                      Imprimir
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <strong>05/11/2025 16:00</strong><br />
                    <small class="text-muted">Ontem</small>
                  </td>
                  <td>
                    <strong>Maria Santos</strong><br />
                    <small class="text-muted">52 anos, F</small>
                  </td>
                  <td>Dor tor√°cica at√≠pica</td>
                  <td>
                    <strong>Z00.0</strong> - Exame m√©dico geral<br />
                    <small class="text-muted">Investiga√ß√£o</small>
                  </td>
                  <td>
                    <span class="badge badge--warning">Em andamento</span>
                  </td>
                  <td>
                    <button class="btn btn-secondary btn-sm">Ver</button>
                    <button class="btn btn-primary btn-sm">Editar</button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <strong>04/11/2025 09:30</strong><br />
                    <small class="text-muted">2 dias atr√°s</small>
                  </td>
                  <td>
                    <strong>Pedro Lima</strong><br />
                    <small class="text-muted">38 anos, M</small>
                  </td>
                  <td>Check-up cardiol√≥gico</td>
                  <td>
                    <strong>Z00.0</strong> - Exame normal<br />
                    <small class="text-success">Liberado</small>
                  </td>
                  <td><span class="badge badge--success">Finalizada</span></td>
                  <td>
                    <button class="btn btn-secondary btn-sm">Ver</button>
                    <button class="btn btn-outline btn-sm">Imprimir</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagina√ß√£o melhorada -->
          <div
            class="d-flex justify-between align-center mt-4"
            style="padding: 16px"
          >
            <p class="text-muted">Mostrando 3 de 28 consultas</p>
            <div class="d-flex" style="gap: var(--spacing-xs)">
              <button class="btn btn-outline btn-sm">¬´ Anterior</button>
              <button class="btn btn-primary btn-sm">1</button>
              <button class="btn btn-outline btn-sm">2</button>
              <button class="btn btn-outline btn-sm">3</button>
              <button class="btn btn-outline btn-sm">Pr√≥ximo ¬ª</button>
            </div>
          </div>
        </div>

        <!-- Estat√≠sticas aprimoradas -->
        <div class="grid grid-4" style="margin-top: 32px">
          <div class="stat-card">
            <div class="stat-number">28</div>
            <div class="stat-label">Consultas no M√™s</div>
            <div class="stat-trend">+12% vs m√™s anterior</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">18</div>
            <div class="stat-label">Pacientes √önicos</div>
            <div class="stat-trend">+5% vs m√™s anterior</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">6</div>
            <div class="stat-label">Primeiras Consultas</div>
            <div class="stat-trend">+2 novos pacientes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">2</div>
            <div class="stat-label">Urg√™ncias</div>
            <div class="stat-trend">Dentro do esperado</div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <p>&copy; 2025 MediSync. Sistema m√©dico profissional.</p>
      </div>
    </footer>

    <script src="../assets/js/main.js"></script>
    <script>
      let currentStep = 1;
      const totalSteps = 3;
      let selectedDiagnoses = [];

      // Controle do Wizard
      function changeStep(direction) {
        const newStep = currentStep + direction;

        if (newStep < 1 || newStep > totalSteps) return;

        // Validar etapa atual antes de prosseguir
        if (direction > 0 && !validateCurrentStep()) {
          return;
        }

        // Esconder etapa atual
        document.getElementById(`step-${currentStep}`).style.display = "none";
        document
          .querySelector(`[data-step="${currentStep}"]`)
          .classList.remove("active");

        // Marcar como completa se indo para frente
        if (direction > 0) {
          document
            .querySelector(`[data-step="${currentStep}"]`)
            .classList.add("completed");
        }

        // Mostrar nova etapa
        currentStep = newStep;
        document.getElementById(`step-${currentStep}`).style.display = "block";
        document
          .querySelector(`[data-step="${currentStep}"]`)
          .classList.add("active");

        // Atualizar bot√µes
        updateWizardButtons();

        // Scroll suave para o topo do formul√°rio
        document
          .getElementById("newConsultaForm")
          .scrollIntoView({ behavior: "smooth" });
      }

      function updateWizardButtons() {
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const submitBtn = document.getElementById("submitBtn");

        prevBtn.style.display = currentStep === 1 ? "none" : "block";
        nextBtn.style.display = currentStep === totalSteps ? "none" : "block";
        submitBtn.style.display = currentStep === totalSteps ? "block" : "none";
      }

      function validateCurrentStep() {
        const currentStepDiv = document.getElementById(`step-${currentStep}`);
        const requiredFields = currentStepDiv.querySelectorAll("[required]");

        for (let field of requiredFields) {
          if (!field.value.trim()) {
            field.focus();
            showToast(
              `Campo "${field.previousElementSibling.textContent}" √© obrigat√≥rio`,
              "error"
            );
            return false;
          }
        }

        // Valida√ß√µes espec√≠ficas por etapa
        if (currentStep === 2) {
          const pa = currentStepDiv.querySelector('[data-validate="pa"]').value;
          const fc = currentStepDiv.querySelector('[data-validate="fc"]').value;

          if (pa && !pa.match(/^\d{2,3}x\d{2,3}$/)) {
            showToast(
              "Formato de press√£o arterial inv√°lido (ex: 120x80)",
              "error"
            );
            return false;
          }

          if (fc && (fc < 30 || fc > 220)) {
            showToast(
              "Frequ√™ncia card√≠aca deve estar entre 30 e 220 bpm",
              "error"
            );
            return false;
          }
        }

        return true;
      }

      // C√°lculo autom√°tico do IMC
      function calculateIMC() {
        const peso = parseFloat(
          document.querySelector('input[placeholder="70.5"]').value
        );
        const altura = parseFloat(
          document.querySelector('input[placeholder="175"]').value
        );

        if (peso && altura) {
          const alturaM = altura / 100;
          const imc = peso / (alturaM * alturaM);
          const imcResult = document.getElementById("imcResult");

          imcResult.value = imc.toFixed(1);

          // Classifica√ß√£o do IMC
          let classificacao = "";
          if (imc < 18.5) classificacao = "(Abaixo do peso)";
          else if (imc < 25) classificacao = "(Peso normal)";
          else if (imc < 30) classificacao = "(Sobrepeso)";
          else classificacao = "(Obesidade)";

          imcResult.value = `${imc.toFixed(1)} ${classificacao}`;
        }
      }

      // Busca de CID-10 aprimorada
      function searchCID10Suggestions(query) {
        const resultsDiv = document.getElementById("cid10Results");

        if (query.length < 2) {
          resultsDiv.innerHTML = "";
          return;
        }

        const results = searchCID10(query);

        let html = "";
        results.forEach(([code, description]) => {
          html += `
          <div class="card" style="cursor: pointer; margin-bottom: 8px; padding: 12px; border: 1px solid var(--cinza-neutro);" 
               onclick="selectDiagnosis('${code}', '${description}')">
            <strong>${code}</strong> - ${description}
          </div>
        `;
        });

        resultsDiv.innerHTML = html;
      }

      function selectDiagnosis(code, description) {
        const exists = selectedDiagnoses.find((d) => d.code === code);
        if (exists) {
          showToast("Diagn√≥stico j√° adicionado", "warning");
          return;
        }

        selectedDiagnoses.push({ code, description });
        updateSelectedDiagnoses();

        document.getElementById("cidSearch").value = "";
        document.getElementById("cid10Results").innerHTML = "";
      }

      function removeDiagnosis(code) {
        selectedDiagnoses = selectedDiagnoses.filter((d) => d.code !== code);
        updateSelectedDiagnoses();
      }

      function updateSelectedDiagnoses() {
        const container = document.getElementById("selectedDiagnoses");

        if (selectedDiagnoses.length === 0) {
          container.innerHTML = "";
          return;
        }

        let html =
          '<h5 style="margin-bottom: 12px;">Diagn√≥sticos Selecionados:</h5>';
        selectedDiagnoses.forEach((diagnosis, index) => {
          const isPrimary = index === 0;
          html += `
          <div class="card" style="margin-bottom: 8px; padding: 12px; background: ${
            isPrimary ? "#e8f5e8" : "#f8f9fa"
          };">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${diagnosis.code}</strong> - ${diagnosis.description}
                ${
                  isPrimary
                    ? '<span style="color: var(--verde-agua); font-weight: bold;">(Principal)</span>'
                    : ""
                }
              </div>
              <button type="button" onclick="removeDiagnosis('${
                diagnosis.code
              }')" 
                      style="background: none; border: none; color: var(--rosa-vivo); cursor: pointer;">√ó</button>
            </div>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      function showNewConsultaForm() {
        document.getElementById("newConsultaForm").style.display = "block";
        document
          .getElementById("newConsultaForm")
          .scrollIntoView({ behavior: "smooth" });

        // Reset wizard
        currentStep = 1;
        selectedDiagnoses = [];
        updateWizardButtons();

        // Mostrar apenas primeira etapa
        for (let i = 1; i <= totalSteps; i++) {
          document.getElementById(`step-${i}`).style.display =
            i === 1 ? "block" : "none";
          const stepElement = document.querySelector(`[data-step="${i}"]`);
          stepElement.classList.remove("active", "completed");
          if (i === 1) stepElement.classList.add("active");
        }
      }

      function hideNewConsultaForm() {
        document.getElementById("newConsultaForm").style.display = "none";
      }

      function searchPatients(query) {
        const resultsDiv = document.getElementById("patientResults");

        if (query.length < 2) {
          resultsDiv.innerHTML = "";
          return;
        }

        // Dados simulados com mais detalhes
        const mockPatients = [
          {
            id: 1,
            name: "Jo√£o Silva",
            cpf: "123.456.789-00",
            age: 45,
            lastVisit: "01/10/2025",
          },
          {
            id: 2,
            name: "Maria Santos",
            cpf: "987.654.321-00",
            age: 52,
            lastVisit: "15/09/2025",
          },
          {
            id: 3,
            name: "Pedro Lima",
            cpf: "456.789.123-00",
            age: 38,
            lastVisit: "20/10/2025",
          },
          {
            id: 4,
            name: "Ana Costa",
            cpf: "789.123.456-00",
            age: 29,
            lastVisit: "Primeira consulta",
          },
        ];

        const filtered = mockPatients.filter(
          (p) =>
            p.name.toLowerCase().includes(query.toLowerCase()) ||
            p.cpf.includes(query)
        );

        let html = "";
        filtered.forEach((patient) => {
          html += `
          <div class="card" style="cursor: pointer; margin-bottom: 8px; padding: 12px; border: 1px solid var(--cinza-neutro);" 
               onclick="selectPatient('${patient.name}', '${patient.cpf}', ${patient.age})">
            <div style="display: flex; justify-content: space-between;">
              <div>
                <strong>${patient.name}</strong><br>
                <small>CPF: ${patient.cpf} | ${patient.age} anos</small>
              </div>
              <div style="text-align: right;">
                <small class="text-muted">√öltima consulta:<br>${patient.lastVisit}</small>
              </div>
            </div>
          </div>
        `;
        });

        resultsDiv.innerHTML = html;
      }

      function selectPatient(name, cpf, age) {
        document.querySelector(
          '#step-1 input[placeholder*="Digite nome ou CPF"]'
        ).value = `${name} - ${cpf}`;
        document.getElementById("patientResults").innerHTML = "";

        showToast(`Paciente ${name} selecionado`, "success");
      }

      function logout() {
        localStorage.clear();
        window.location.href = "../index.html";
      }

      // Submiss√£o do formul√°rio
      document
        .getElementById("consultaForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!validateCurrentStep()) return;

          const success = await submitForm(
            new FormData(this),
            "Consulta registrada com sucesso!"
          );

          if (success) {
            hideNewConsultaForm();
            this.reset();
            selectedDiagnoses = [];

            // Simular atualiza√ß√£o da lista de consultas
            setTimeout(() => {
              showToast("Lista de consultas atualizada", "info");
            }, 1000);
          }
        });
    </script>
  </body>
</html>
